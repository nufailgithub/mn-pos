generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}


// User Management
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  name                   String
  password               String
  role                   UserRole  @default(CASHIER)
  isActive               Boolean   @default(true)
  passwordResetToken     String?   @unique
  passwordResetExpires   DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  sales                  Sale[]
  stockAdjustments       StockAdjustment[]

  @@index([email])
  @@index([passwordResetToken])
  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
}

// Product Categories
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]
  subCategories SubCategory[]

  @@map("categories")
}

// Sub Categories
model SubCategory {
  id          String    @id @default(cuid())
  name        String
  categoryId  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([name, categoryId])
  @@map("sub_categories")
}

// Products/Inventory
model Product {
  id              String   @id @default(cuid())
  name            String
  productId       String   @unique @map("product_id")
  sku             String   @unique
  barcode         String?  @unique
  categoryId      String
  subCategoryId   String?
  costPrice       Float    @map("cost_price")
  sellingPrice    Float    @map("selling_price")
  brand           String?
  stockAlertLimit Int      @default(10) @map("stock_alert_limit")
  freeSize        Boolean  @default(false) @map("free_size")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subCategory SubCategory? @relation(fields: [subCategoryId], references: [id], onDelete: SetNull)
  productSizes ProductSize[]
  saleItems   SaleItem[]
  stockAdjustments StockAdjustment[]

  @@index([categoryId])
  @@index([subCategoryId])
  @@index([productId])
  @@index([sku])
  @@index([barcode])
  @@map("products")
}

// Product Sizes and Quantities
model ProductSize {
  id        String   @id @default(cuid())
  productId String
  size      String
  quantity  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockAdjustments StockAdjustment[]

  @@unique([productId, size])
  @@map("product_sizes")
}

// Customers & Loans
model Customer {
  id              String   @id @default(cuid())
  name            String
  phone           String   @unique
  email           String?
  address         String?
  totalDebt       Float    @default(0) // Amount customer owes (due)
  totalAdvance    Float    @default(0) // Overpayment / advance (we owe customer)
  totalPurchases  Float    @default(0) // Sum of all sale totals linked to customer
  totalPaid       Float    @default(0) // Sum of amounts paid (cash/bank) on their bills
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sales        Sale[]
  transactions CustomerTransaction[]

  @@index([phone])
  @@map("customers")
}

enum TransactionType {
  DEBT_INC   // Debt Increased (Credit Sale)
  DEBT_DEC   // Debt Decreased (Repayment)
  ADVANCE_INC // Advance Increased (Overpayment added as customer credit)
  ADVANCE_DEC // Advance Decreased (e.g. used against next bill)
}

model CustomerTransaction {
  id          String          @id @default(cuid())
  customerId  String
  type        TransactionType
  amount      Float
  description String?
  referenceId String?         // Link to Sale ID if applicable
  date        DateTime        @default(now())
  createdAt   DateTime        @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@map("customer_transactions")
}

// Sales/Billing
enum PaymentMethod {
  CASH
  CARD
  MOBILE
  BANK_TRANSFER
  CREDIT
  LOAN // Kept for backward compatibility; not shown in UI
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PAID
  PARTIAL
  PENDING
}

model Sale {
  id            String        @id @default(cuid())
  saleNumber    String        @unique
  subtotal      Float
  tax           Float         @default(0)
  discount      Float         @default(0)
  total         Float
  balanceAmount Float         @default(0) // Remaining amount to be paid (if any)
  status        SaleStatus    @default(COMPLETED)
  paymentStatus PaymentStatus @default(PAID)
  
  customerId    String?
  customerName  String?       // Keep for quick reference or walk-in customers
  customerPhone String?
  
  cashierId     String
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  cashier   User          @relation(fields: [cashierId], references: [id])
  customer  Customer?     @relation(fields: [customerId], references: [id])
  saleItems SaleItem[]
  payments  SalePayment[]

  @@index([saleNumber])
  @@index([cashierId])
  @@index([customerId])
  @@index([createdAt])
  @@map("sales")
}

model SalePayment {
  id        String        @id @default(cuid())
  saleId    String
  amount    Float
  method    PaymentMethod
  reference String?       // e.g., Transaction ID for Card/Mobile
  createdAt DateTime      @default(now())

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@map("sale_payments")
}

model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  productId String
  size      String?  // Size for sized products, null for free size
  quantity  Int
  price     Float    // Price per unit at time of sale
  discount  Float    @default(0) // Discount amount for this item
  discountType String? // "PERCENTAGE" or "AMOUNT"
  subtotal  Float    // (price * quantity) - discount
  createdAt DateTime @default(now())

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

// Stock Adjustments
enum StockAdjustmentType {
  ADD
  REDUCE
}

enum StockAdjustmentReason {
  NEW_STOCK_ARRIVAL
  DAMAGED_ITEM
  LOST_THEFT
  MANUAL_CORRECTION
  RETURN_FROM_CUSTOMER
  OTHER
}

model StockAdjustment {
  id            String                @id @default(cuid())
  productId     String
  productSizeId String?               // null for free size products
  size          String?                // Size name for reference
  type          StockAdjustmentType
  quantity      Int                   // Positive number (absolute value)
  reason        StockAdjustmentReason
  reasonNote    String?               // Additional notes
  beforeQty     Int                   // Quantity before adjustment
  afterQty      Int                   // Quantity after adjustment
  adjustedBy    String                // User ID who made the adjustment
  createdAt     DateTime              @default(now())

  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  productSize ProductSize? @relation(fields: [productSizeId], references: [id], onDelete: Cascade)
  adjustedByUser User      @relation(fields: [adjustedBy], references: [id])

  @@index([productId])
  @@index([productSizeId])
  @@index([adjustedBy])
  @@index([createdAt])
  @@map("stock_adjustments")
}

// Employee Management (Simplified)
enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

model Employee {
  id          String         @id @default(cuid())
  employeeId  String         @unique // Auto-generated (e.g. EMP-001)
  name        String
  phone       String?
  basicSalary Float          @map("basic_salary") // Monthly salary
  status      EmployeeStatus @default(ACTIVE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  advances       SalaryAdvance[]
  salaryPayments SalaryPayment[]

  @@map("employees")
}

model SalaryAdvance {
  id         String   @id @default(cuid())
  employeeId String
  amount     Float
  date       DateTime @default(now())
  note       String?
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("salary_advances")
}

// Salary payments (partial or full) per month
model SalaryPayment {
  id         String   @id @default(cuid())
  employeeId String
  amount     Float
  forMonth   DateTime @map("for_month") // First day of the month this payment is for
  note       String?
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([forMonth])
  @@map("salary_payments")
}

// Password Reset Rate Limiting
model PasswordResetAttempt {
  id          String   @id @default(cuid())
  email       String
  attemptedAt DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  @@index([email])
  @@index([attemptedAt])
  @@map("password_reset_attempts")
}

// Security Audit Logs
model AuditLog {
  id          String   @id @default(cuid())
  action      String   // PASSWORD_RESET_REQUESTED, PASSWORD_RESET_COMPLETED, LOGIN_FAILED, etc.
  userId      String?
  email       String?
  ipAddress   String?
  userAgent   String?
  details     String?  // JSON string for additional info
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([email])
  @@index([createdAt])
  @@map("audit_logs")
}
